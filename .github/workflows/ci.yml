# Workflow-Name for Continuous Integration
name: CI Pipeline

# Trigger bei Push oder Pull-Request auf den main-Branch
on:
    push:
        branches: ['main']
    pull_request:
        branches: ['main']

# Workflow besteht aus Jobs
jobs:
    # Namen des Jobs
    build:
        # Läuft auf einem Ubuntu-Latest-Image
        runs-on: ubuntu-latest
        # Job besteht aus mehreren Schritten
        steps:
            # Nutzt den Checkout-Action, um den Code zu holen
            - name: Checkout repository
              uses: actions/checkout@v4

            # Debugging
            - name: Show files (debug)
              # run in Shell
              run: |
                  pwd
                  ls -la
                  echo "----"
                  ls -la .github || true
                  echo "----"
                  cat package.json || true

            # Setzt Node.js Umgebung auf
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            # Installiert Abhängigkeiten
            - name: Install dependencies
              # Braucht package-lock.json für npm ci (Kein package-lock.json kein npm ci)
              # npm ci statt npm install für saubere Installation
              run: npm ci

            # Sicherheitsprüfungen der Abhängigkeiten
            - name: Dependencies vulnerability check
              # --audit-level=high um nur hohe und kritische Probleme zu melden
              run: npm audit --audit-level=high

            # Statische Code-Analyse mit Semgrep
            - name: SAST (Semgrep)
              uses: returntocorp/semgrep-action@v1
              with:
                  # Verwendet die vordefinierte CI-Konfiguration
                  config: p/ci

            # Führt Linting und Tests aus
            - name: Run lint
              run: npm run lint

            - name: Run tests
              run: npm test

            - name: Build Docker Image
              run: docker build --no-cache -t devsecops-demo:ci .

            - name: Scan Docker Image with Trivy
              uses: aquasecurity/trivy-action@0.24.0
              with:
                  image-ref: devsecops-demo:local
                  exit-code: '1'
                  severity: 'CRITICAL,HIGH'
